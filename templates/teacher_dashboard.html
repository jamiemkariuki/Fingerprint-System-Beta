{% extends 'base.html' %}
{% block content %}

<div class="admin-nav">
    <button class="tab-link active" onclick="openTab(event, 'Overview')">Overview</button>
    <button class="tab-link" onclick="openTab(event, 'Enrollment')">Subject Enrollment</button>
    <button class="tab-link" onclick="openTab(event, 'Auditing')">Auditing Clearance</button>
    <button class="tab-link" onclick="openTab(event, 'Students')">Students</button>
    <button class="tab-link" onclick="openTab(event, 'Parents')">Parents</button>
    <button class="tab-link" onclick="openTab(event, 'Timetable')">Timetable</button>
</div>

<div id="Overview" class="tab-content active">
    <div class="card">
        <h3>Class Overview</h3>
        <p><strong>Teacher:</strong> {{ teacher.name }}</p>
        <p><strong>Class:</strong> {{ teacher.class }}</p>
        <p><strong>Email:</strong> {{ teacher.email }}</p>
        <h4>Students in Class</h4>
        <ul>
            {% for u in users %}
            <li>{{ u.name }} - {{ u.status }}</li>
            {% endfor %}
        </ul>
    </div>
</div>

<div id="Enrollment" class="tab-content">
    <div class="card">
        <h3>Link Subject to Student (Enrollment)</h3>
        <p class="small text-muted">Link a student to a subject to allow clearance auditing. Unlinking will remove both
            the enrollment and any existing audit record.</p>
        <form method="post" action="{{ url_for('admin.link_subject') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="enroll_student">Student</label>
                    <select id="enroll_student" name="student_id" required>
                        <option value="">-- Select Student --</option>
                        {% for u in users %}
                        <option value="{{ u.id }}">{{ u.name }} ({{ u.class }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label for="enroll_subject">Subject</label>
                    <select id="enroll_subject" name="subject_id" required>
                        <option value="">-- Select Subject --</option>
                        {% for s in subjects %}
                        <option value="{{ s.id }}">{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" style="padding: 10px 20px;">Link Subject</button>
            </div>
        </form>

        <h4 style="margin-top: 30px;">Current Subject Links</h4>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Subject</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% if enrollment_links %}
                    {% for enroll in enrollment_links %}
                    <tr>
                        <td>{{ enroll.student_name }}</td>
                        <td>{{ enroll.subject_name }}</td>
                        <td>
                            <form method="post" action="{{ url_for('admin.unlink_subject') }}"
                                onsubmit="return confirm('Unlink this subject? This will also delete any existing clearance audit.');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <input type="hidden" name="student_id" value="{{ enroll.student_id }}">
                                <input type="hidden" name="subject_id" value="{{ enroll.subject_id }}">
                                <button type="submit" class="btn btn-small btn-secondary">Unlink</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="3" style="text-align: center;">No subject links found.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="Auditing" class="tab-content">
    <div class="card">
        <h3>Student Auditing Management</h3>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Update Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% if audit_links %}
                    {% for audit in audit_links %}
                    <tr>
                        <td>{{ audit.student_name }}</td>
                        <td>{{ audit.subject_name }}</td>
                        <td>
                            {% if audit.status == 'Cleared' %}
                            <span style="color: green;">✓ Cleared</span>
                            {% elif audit.status == 'Not Cleared' %}
                            <span style="color: red;">✗ Not Cleared</span>
                            {% else %}
                            <span style="color: orange;">⚠ Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            <form method="post" action="{{ url_for('teacher.update_audit_status') }}"
                                style="display: flex; gap: 5px;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <input type="hidden" name="audit_id" value="{{ audit.id }}">
                                <select name="status" style="width: 120px; padding: 2px;">
                                    <option value="Pending" {% if audit.status=='Pending' %}selected{% endif %}>Pending
                                    </option>
                                    <option value="Cleared" {% if audit.status=='Cleared' %}selected{% endif %}>Cleared
                                    </option>
                                    <option value="Not Cleared" {% if audit.status=='Not Cleared' %}selected{% endif %}>
                                        Not Cleared</option>
                                </select>
                                <input name="notes" placeholder="Notes..." value="{{ audit.notes or '' }}"
                                    style="width: 100px; padding: 2px;">
                                <button type="submit" class="btn btn-small">Update</button>
                            </form>
                            <form method="post" action="{{ url_for('teacher.delete_audit') }}" style="display: inline;"
                                onsubmit="return confirm('Are you sure you want to delete this clearance record?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <input type="hidden" name="audit_id" value="{{ audit.id }}">
                                <button type="submit" class="btn btn-small btn-secondary"
                                    style="background-color: #dc3545;">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center;">No subjects assigned for auditing yet.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h3>Available for Auditing</h3>
        <p class="small text-muted">The following students are enrolled in subjects but have not had their clearance
            audit initialized yet.</p>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Subject</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% set enrollment_with_audit = [] %}
                    {% for audit in audit_links %}
                    {% set _ = enrollment_with_audit.append(audit.student_name ~ '|' ~ audit.subject_name) %}
                    {% endfor %}

                    {% set available_count = 0 %}
                    {% for enroll in enrollment_links %}
                    {% set key = enroll.student_name ~ '|' ~ enroll.subject_name %}
                    {% if key not in enrollment_with_audit %}
                    {% set available_count = available_count + 1 %}
                    <tr>
                        <td>{{ enroll.student_name }}</td>
                        <td>{{ enroll.subject_name }}</td>
                        <td>
                            <form method="post" action="{{ url_for('admin.create_audit') }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <input type="hidden" name="student_id" value="{{ enroll.student_id }}">
                                <input type="hidden" name="subject_id" value="{{ enroll.subject_id }}">
                                <button type="submit" class="btn btn-small">Initialize Audit</button>
                            </form>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}

                    {% if available_count == 0 %}
                    <tr>
                        <td colspan="3" style="text-align: center;">No new subjects available for auditing. Ensure
                            students are "Linked" in the Enrollment tab.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="Students" class="tab-content">
    <div class="card">
        <h3>Student Management</h3>
        <form method="post" action="{{ url_for('teacher.create_student') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <label for="student_name">Name</label>
            <input id="student_name" name="name" required>
            <label for="student_username">Username</label>
            <input id="student_username" name="username" required>
            <label for="student_class">Class</label>
            <input id="student_class" name="class" value="{{ teacher.class }}" required>
            <label for="student_password">Password</label>
            <input id="student_password" name="password" type="password" required>
            <div style="margin: 15px 0;">
                <input type="checkbox" id="enroll_now" name="fingerprint" value="1">
                <label for="enroll_now" style="display:inline; font-weight: normal;">Enroll Fingerprint Now</label>
            </div>
            <button type="submit">Create Student</button>
        </form>
        {% if users %}
        <h4>Existing Students</h4>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Class</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ u.name }}</td>
                    <td>{{ u.class }}</td>
                    <td>{{ u.status }}</td>
                    <td>
                        <a href="{{ url_for('teacher.student_attendance_pdf', student_id=u.id) }}" class="btn btn-small"
                            target="_blank">Attendance PDF</a>
                        <a href="{{ url_for('teacher.student_audit_pdf', student_id=u.id) }}" class="btn btn-small"
                            target="_blank">Clearance PDF</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

<div id="Timetable" class="tab-content">
    <div class="card">
        <h3>Manage Class Timetable ({{ teacher.class }})</h3>
        <form id="timetable-form" method="post" action="{{ url_for('teacher.manage_timetable') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" id="tt_action" name="action" value="add">
            <input type="hidden" id="tt_id" name="timetable_id" value="">

            <label for="tt_subject">Subject</label>
            <select id="tt_subject" name="subject_id" required>
                <option value="">-- Select Subject --</option>
                {% for s in subjects %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>

            <label for="tt_teacher">Teacher (Optional)</label>
            <select id="tt_teacher" name="teacher_id">
                <option value="">-- No Teacher Assigned --</option>
                {% for t in teachers %}
                <option value="{{ t.id }}">{{ t.name }}</option>
                {% endfor %}
            </select>

            <label for="tt_day">Day</label>
            <select id="tt_day" name="day_of_week" required>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
            </select>

            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label for="tt_start">Start Time</label>
                    <input type="time" id="tt_start" name="start_time" required>
                </div>
                <div style="flex: 1;">
                    <label for="tt_end">End Time</label>
                    <input type="time" id="tt_end" name="end_time" required>
                </div>
            </div>

            <button type="submit" id="tt_submit_btn">Add Entry</button>
            <button type="button" id="tt_cancel_btn" style="display: none; background-color: grey;"
                onclick="cancelTTExted()">Cancel Edit</button>
        </form>
        </form>

        <h4>Current Timetable</h4>
        {% if timetables %}
        <table>
            <thead>
                <tr>
                    <th>Day</th>
                    <th>Time</th>
                    <th>Subject</th>
                    <th>Teacher</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for t in timetables %}
                <tr class="{% if t.teacher_id == teacher.id %}highlight-row{% endif %}">
                    <td>{{ t.day_of_week }}</td>
                    <td>{{ t.start_time }} - {{ t.end_time }}</td>
                    <td>{{ t.subject_name }}</td>
                    <td>{{ t.teacher_name or '-' }}</td>
                    <td>
                        <button type="button" class="btn-small"
                            onclick="editTimetable('{{ t.id }}', '{{ t.subject_id }}', '{{ t.teacher_id or '' }}', '{{ t.day_of_week }}', '{{ t.start_time }}', '{{ t.end_time }}')">
                            Edit
                        </button>
                        <form method="post" action="{{ url_for('teacher.manage_timetable') }}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="timetable_id" value="{{ t.id }}">
                            <button type="submit" class="btn-small btn-secondary">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No timetable entries set.</p>
        {% endif %}
    </div>
</div>

<div id="Parents" class="tab-content">
    <div class="card">
        <h3>Parent Management</h3>
        <form method="post" action="{{ url_for('teacher.create_parent') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <label for="parent_name">Name</label>
            <input id="parent_name" name="name" required>
            <label for="parent_username">Username</label>
            <input id="parent_username" name="username" required>
            <label for="parent_email">Email</label>
            <input id="parent_email" name="email" type="email" required>
            <label for="parent_phone">Phone</label>
            <input id="parent_phone" name="phone">
            <label for="parent_password">Password</label>
            <input id="parent_password" name="password" type="password" required>
            <button type="submit">Create Parent</button>
        </form>
        <form method="post" action="{{ url_for('teacher.link_student_parent') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <label for="link_student">Student</label>
            <select id="link_student" name="student_id" required>
                <option value="">-- Select Student --</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.name }}</option>
                {% endfor %}
            </select>
            <label for="link_parent">Parent</label>
            <select id="link_parent" name="parent_id" required>
                <option value="">-- Select Parent --</option>
                {% for p in parents %}
                <option value="{{ p.id }}">{{ p.name }}</option>
                {% endfor %}
            </select>
            <label for="relationship">Relationship</label>
            <input id="relationship" name="relationship" placeholder="e.g. Parent" required>
            <button type="submit">Link</button>
        </form>
        {% if parents %}
        <h4>Existing Parents</h4>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                </tr>
            </thead>
            <tbody>
                {% for p in parents %}
                <tr>
                    <td>{{ p.name }}</td>
                    <td>{{ p.email }}</td>
                    <td>{{ p.phone or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

<style>
    .admin-nav {
        display: flex;
        overflow-x: auto;
        margin-bottom: 20px;
        border-bottom: 2px solid var(--border-color);
        background-color: var(--off-white);
        padding: 0 10px;
    }

    .tab-link {
        background-color: #f8f9fa;
        border: 1px solid var(--border-color);
        padding: 12px 20px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        border-radius: 5px 5px 0 0;
        margin-right: 5px;
        color: var(--text-dark);
        transition: background-color 0.3s, color 0.3s;
    }

    .tab-link:hover {
        background-color: #e9ecef;
    }

    .tab-link.active {
        background-color: var(--brown-medium);
        color: white;
        border-bottom-color: var(--brown-medium);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .highlight-row {
        background-color: #fff9c4 !important;
        /* Soft yellow highlight */
        font-weight: bold;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tabcontent = document.getElementsByClassName("tab-content");
        for (var i = 0; i < tabcontent.length; i++) {
            if (!tabcontent[i].classList.contains('active')) {
                tabcontent[i].style.display = "none";
            }
        }
    });

    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    function editTimetable(id, subjectId, teacherId, day, start, end) {
        document.getElementById('tt_id').value = id;
        document.getElementById('tt_action').value = 'update';
        document.getElementById('tt_subject').value = subjectId;
        document.getElementById('tt_teacher').value = teacherId;
        document.getElementById('tt_day').value = day;

        // Format TIME (HH:MM:SS) to HH:MM for input[type="time"]
        document.getElementById('tt_start').value = start.substring(0, 5);
        document.getElementById('tt_end').value = end.substring(0, 5);

        document.getElementById('tt_submit_btn').innerText = 'Update Entry';
        document.getElementById('tt_cancel_btn').style.display = 'inline-block';

        // Scroll to form
        document.getElementById('Timetable').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelTTExted() {
        document.getElementById('timetable-form').reset();
        document.getElementById('tt_id').value = '';
        document.getElementById('tt_action').value = 'add';
        document.getElementById('tt_submit_btn').innerText = 'Add Entry';
        document.getElementById('tt_cancel_btn').style.display = 'none';
    }
</script>

{% endblock %}